<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Semanas</title>
    <meta name="theme-color" content="#0b0e11" />
    <style>
        :root {
            --bg: #0b0e11;
            --panel: #0f1319;
            --fg: #ffffff;
            --muted: rgba(255, 255, 255, .55);
            --faint: rgba(255, 255, 255, .18);
            --ring: rgba(255, 255, 255, .22);
            --ring-strong: rgba(255, 255, 255, .36);
            --fill: #ffffff;
            --fill-soft: rgba(255, 255, 255, .92);

            --accent: #00ff9c;
            --accent2: #00c97a;

            --r: 999px;
            --shadow: 0 10px 30px rgba(0, 0, 0, .35);
            --ease: cubic-bezier(.2, .9, .2, 1);
            --dur: 360ms;
            --blur: 10px;
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg: #f6f7f9;
                --panel: #ffffff;
                --fg: #0b0e11;
                --muted: rgba(11, 14, 17, .6);
                --faint: rgba(11, 14, 17, .14);
                --ring: rgba(11, 14, 17, .18);
                --ring-strong: rgba(11, 14, 17, .32);
                --fill: #0b0e11;
                --fill-soft: rgba(11, 14, 17, .92);
                --shadow: 0 10px 30px rgba(0, 0, 0, .12);
            }
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            background: radial-gradient(1200px 600px at 20% -10%, rgba(0, 255, 156, .10), transparent 55%),
                radial-gradient(900px 500px at 100% 0%, rgba(0, 201, 122, .08), transparent 50%),
                var(--bg);
            color: var(--fg);
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }

        .app {
            min-height: 100%;
            padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            max-width: 520px;
            margin: 0 auto;
        }

        header {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            padding: 10px 4px 4px 4px;
        }

        .title {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .title h1 {
            margin: 0;
            font-size: 18px;
            letter-spacing: .2px;
            font-weight: 650;
        }

        .title .sub {
            font-size: 12px;
            color: var(--muted);
        }

        .pill {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: var(--r);
            background: color-mix(in srgb, var(--panel) 80%, transparent);
            border: 1px solid color-mix(in srgb, var(--ring) 65%, transparent);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            font-size: 12px;
            color: var(--muted);
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: var(--r);
            background: var(--accent);
            box-shadow: 0 0 0 6px color-mix(in srgb, var(--accent) 20%, transparent);
        }

        .stage {
            position: relative;
            flex: 1;
            min-height: 420px;
        }

        .screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            gap: 14px;

            transform: translateY(0) scale(1);
            filter: blur(0px);
            opacity: 1;

            transition:
                transform var(--dur) var(--ease),
                filter var(--dur) var(--ease),
                opacity var(--dur) var(--ease);
            will-change: transform, filter, opacity;
        }

        .screen.hidden {
            pointer-events: none;
            opacity: 0;
            transform: translateY(14px) scale(.985);
            filter: blur(var(--blur));
        }

        .card {
            background: color-mix(in srgb, var(--panel) 84%, transparent);
            border: 1px solid color-mix(in srgb, var(--ring) 60%, transparent);
            border-radius: 20px;
            padding: 14px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .weeksGrid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 10px;
            align-content: start;
        }

        @media (max-width: 390px) {
            .weeksGrid {
                grid-template-columns: repeat(9, 1fr);
            }
        }

        @media (max-width: 340px) {
            .weeksGrid {
                grid-template-columns: repeat(8, 1fr);
            }
        }

        .circleBtn {
            appearance: none;
            border: 0;
            background: transparent;
            padding: 0;
            margin: 0;
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: var(--r);
            display: grid;
            place-items: center;
            position: relative;
            cursor: pointer;
            touch-action: manipulation;
        }

        .circle {
            width: 100%;
            height: 100%;
            border-radius: var(--r);
            border: 1px solid var(--ring);
            background: transparent;
            transition: transform 140ms var(--ease), border-color 140ms var(--ease), background 140ms var(--ease);
            will-change: transform;
        }

        .circleBtn:active .circle {
            transform: scale(.96);
        }

        .filled .circle {
            background: var(--fill-soft);
            border-color: color-mix(in srgb, var(--fill) 25%, transparent);
        }

        .currentWeek .circle {
            border-color: color-mix(in srgb, var(--accent) 70%, var(--ring));
            box-shadow: 0 0 0 6px color-mix(in srgb, var(--accent) 14%, transparent);
        }

        .weekNum {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            font-size: 10px;
            font-weight: 650;
            letter-spacing: .2px;
            color: color-mix(in srgb, var(--fg) 70%, transparent);
            mix-blend-mode: difference;
            opacity: .85;
            pointer-events: none;
            user-select: none;
        }

        .hint {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            padding: 0 2px;
            color: var(--muted);
            font-size: 12px;
        }

        .legend {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .legItem {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mini {
            width: 10px;
            height: 10px;
            border-radius: var(--r);
            border: 1px solid var(--ring-strong);
            background: transparent;
        }

        .mini.f {
            background: var(--fill-soft);
            border-color: color-mix(in srgb, var(--fill) 25%, transparent);
        }

        /* Week detail */
        .topRow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .backBtn {
            appearance: none;
            border: 1px solid color-mix(in srgb, var(--ring) 70%, transparent);
            background: color-mix(in srgb, var(--panel) 78%, transparent);
            color: var(--fg);
            border-radius: var(--r);
            padding: 10px 12px;
            font-size: 12px;
            font-weight: 650;
            letter-spacing: .2px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            cursor: pointer;
            touch-action: manipulation;
            transition: transform 140ms var(--ease);
        }

        .backBtn:active {
            transform: scale(.98);
        }

        .weekTitle {
            display: flex;
            flex-direction: column;
            gap: 2px;
            text-align: right;
            min-width: 0;
        }

        .weekTitle .w {
            font-weight: 700;
            font-size: 14px;
            letter-spacing: .2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .weekTitle .d {
            font-size: 12px;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .daysRow {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .dayCircle {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: var(--r);
            border: 1px solid var(--ring);
            background: transparent;
            display: grid;
            place-items: center;
            position: relative;
            transition: transform 140ms var(--ease), border-color 140ms var(--ease), background 140ms var(--ease);
            will-change: transform;
        }

        .dayBtn {
            appearance: none;
            border: 0;
            background: transparent;
            padding: 0;
            margin: 0;
            width: 100%;
            cursor: pointer;
            touch-action: manipulation;
        }

        .dayBtn:active .dayCircle {
            transform: scale(.96);
        }

        .dayLabel {
            font-size: 12px;
            font-weight: 750;
            letter-spacing: .2px;
            color: var(--fg);
            user-select: none;
        }

        .today .dayCircle {
            border-color: color-mix(in srgb, var(--accent) 75%, var(--ring));
            box-shadow: 0 0 0 6px color-mix(in srgb, var(--accent) 14%, transparent);
        }

        .hasNote .dayCircle {
            background: color-mix(in srgb, var(--accent) 16%, transparent);
            border-color: color-mix(in srgb, var(--accent2) 55%, var(--ring));
        }

        .notePreview {
            margin-top: 12px;
            font-size: 12px;
            color: var(--muted);
            line-height: 1.35;
            min-height: 28px;
            padding: 2px 2px 0 2px;
        }

        .notePreview strong {
            color: color-mix(in srgb, var(--fg) 85%, transparent);
            font-weight: 650;
        }

        /* Modal / sheet */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .35);
            opacity: 0;
            pointer-events: none;
            transition: opacity 220ms var(--ease);
        }

        .overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 12px 16px calc(env(safe-area-inset-bottom) + 12px) 16px;
            transform: translateY(16px);
            filter: blur(var(--blur));
            opacity: 0;
            pointer-events: none;
            transition:
                transform 260ms var(--ease),
                filter 260ms var(--ease),
                opacity 260ms var(--ease);
        }

        .sheet.show {
            transform: translateY(0);
            filter: blur(0);
            opacity: 1;
            pointer-events: auto;
        }

        .sheetCard {
            max-width: 520px;
            margin: 0 auto;
            border-radius: 22px;
            background: color-mix(in srgb, var(--panel) 88%, transparent);
            border: 1px solid color-mix(in srgb, var(--ring) 65%, transparent);
            box-shadow: 0 18px 50px rgba(0, 0, 0, .45);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .grabber {
            width: 44px;
            height: 5px;
            border-radius: var(--r);
            background: color-mix(in srgb, var(--fg) 20%, transparent);
            margin: 0 auto 4px auto;
        }

        .sheetHead {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
        }

        .sheetHead .meta {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

        .sheetHead .meta .t {
            font-weight: 750;
            letter-spacing: .2px;
            font-size: 14px;
        }

        .sheetHead .meta .s {
            font-size: 12px;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .xBtn {
            appearance: none;
            border: 1px solid color-mix(in srgb, var(--ring) 70%, transparent);
            background: transparent;
            color: var(--fg);
            border-radius: var(--r);
            width: 34px;
            height: 34px;
            display: grid;
            place-items: center;
            cursor: pointer;
            touch-action: manipulation;
        }

        .inputWrap {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="text"] {
            width: 100%;
            border-radius: 16px;
            border: 1px solid color-mix(in srgb, var(--ring) 75%, transparent);
            background: color-mix(in srgb, var(--bg) 65%, transparent);
            color: var(--fg);
            padding: 12px 12px;
            font-size: 14px;
            outline: none;
        }

        input[type="text"]::placeholder {
            color: color-mix(in srgb, var(--muted) 85%, transparent);
        }

        .saveBtn {
            appearance: none;
            border: 0;
            border-radius: 16px;
            padding: 12px 14px;
            font-weight: 800;
            letter-spacing: .2px;
            font-size: 13px;
            color: #001b10;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            cursor: pointer;
            touch-action: manipulation;
            transition: transform 140ms var(--ease), filter 140ms var(--ease);
            white-space: nowrap;
        }

        .saveBtn:active {
            transform: scale(.98);
            filter: brightness(.96);
        }

        .counter {
            text-align: right;
            font-size: 11px;
            color: var(--muted);
            padding-right: 2px;
        }

        .footerSpacer {
            height: 6px;
        }

        @media (prefers-reduced-motion: reduce) {
            :root {
                --dur: 0ms;
                --blur: 0px;
            }

            .circleBtn:active .circle,
            .dayBtn:active .dayCircle,
            .backBtn:active,
            .saveBtn:active {
                transform: none;
            }
        }
    </style>
</head>

<body>
    <div class="app" id="app">
        <header>
            <div class="title">
                <h1>Semanas</h1>
                <div class="sub" id="subtitle">—</div>
            </div>
            <div class="pill" aria-label="Hoy">
                <span class="dot" aria-hidden="true"></span>
                <span id="todayPill">—</span>
            </div>
        </header>

        <div class="stage">
            <!-- Screen: Weeks -->
            <section class="screen" id="weeksScreen">
                <div class="card">
                    <div class="hint">
                        <div class="legend">
                            <div class="legItem"><span class="mini f" aria-hidden="true"></span><span>Pasadas</span>
                            </div>
                            <div class="legItem"><span class="mini" aria-hidden="true"></span><span>Futuras</span></div>
                        </div>
                        <div id="weekCount">—</div>
                    </div>

                    <div class="weeksGrid" id="weeksGrid" aria-label="Semanas del año"></div>
                </div>
                <div class="footerSpacer"></div>
            </section>

            <!-- Screen: Week detail -->
            <section class="screen hidden" id="weekScreen" aria-label="Detalle de semana">
                <div class="topRow">
                    <button class="backBtn" id="backBtn" type="button">← Semanas</button>
                    <div class="weekTitle">
                        <div class="w" id="weekTitle">Semana —</div>
                        <div class="d" id="weekRange">—</div>
                    </div>
                </div>

                <div class="card">
                    <div class="daysRow" id="daysRow" aria-label="Días de la semana"></div>
                    <div class="notePreview" id="notePreview"></div>
                </div>
            </section>
        </div>
    </div>

    <!-- Note sheet -->
    <div class="overlay" id="overlay"></div>
    <div class="sheet" id="sheet" role="dialog" aria-modal="true" aria-label="Nota del día">
        <div class="sheetCard">
            <div class="grabber" aria-hidden="true"></div>
            <div class="sheetHead">
                <div class="meta">
                    <div class="t" id="sheetTitle">—</div>
                    <div class="s" id="sheetSub">—</div>
                </div>
                <button class="xBtn" id="closeSheet" type="button" aria-label="Cerrar">✕</button>
            </div>

            <div class="inputWrap">
                <input id="noteInput" type="text" maxlength="50" placeholder="Nota (máx 50 caracteres)..."
                    inputmode="text" />
                <button class="saveBtn" id="saveNote" type="button">Guardar</button>
            </div>
            <div class="counter" id="counter">0/50</div>
        </div>
    </div>

    <script>
        // ========= Helpers de fecha (ISO week, lunes->domingo) =========
        const pad2 = (n) => String(n).padStart(2, "0");

        function fmtDateES(d) {
            // dd/mm
            return `${pad2(d.getDate())}/${pad2(d.getMonth() + 1)}`;
        }

        function dayAbbrES(idxMonday0) {
            // idx 0..6 (lunes..domingo)
            return ["L", "M", "X", "J", "V", "S", "D"][idxMonday0];
        }

        function cloneDate(d) { return new Date(d.getTime()); }

        function startOfISOWeek(date) {
            // lunes 00:00
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const day = d.getDay(); // 0 domingo .. 6 sábado
            const diff = (day === 0 ? -6 : 1 - day); // mover a lunes
            d.setDate(d.getDate() + diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function isoWeekNumber(date) {
            // ISO 8601: semana 1 es la que contiene el primer jueves del año.
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7; // lunes=1..domingo=7
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return { week: weekNo, year: d.getUTCFullYear() };
        }

        function weeksInISOYear(year) {
            // la semana del 28 dic siempre está en la última semana ISO del año
            const { week } = isoWeekNumber(new Date(year, 11, 28));
            return week;
        }

        function isoWeekStartFromWeek(year, week) {
            // lunes de la ISO week "week" del "year"
            const simple = new Date(year, 0, 1 + (week - 1) * 7);
            const dow = simple.getDay(); // 0..6
            const ISOweekStart = new Date(simple);
            const diff = (dow <= 4 ? 1 - dow : 8 - dow); // mover al lunes
            ISOweekStart.setDate(simple.getDate() + diff);
            ISOweekStart.setHours(0, 0, 0, 0);
            return ISOweekStart;
        }

        function addDays(d, n) {
            const x = new Date(d);
            x.setDate(x.getDate() + n);
            return x;
        }

        function isSameDay(a, b) {
            return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
        }

        // ========= Storage =========
        const storageKey = (dateObj) => {
            // YYYY-MM-DD
            return `note:${dateObj.getFullYear()}-${pad2(dateObj.getMonth() + 1)}-${pad2(dateObj.getDate())}`;
        };

        function getNote(dateObj) {
            return localStorage.getItem(storageKey(dateObj)) || "";
        }
        function setNote(dateObj, text) {
            const k = storageKey(dateObj);
            const t = (text || "").slice(0, 50);
            if (t.trim().length === 0) {
                localStorage.removeItem(k);
            } else {
                localStorage.setItem(k, t);
            }
        }

        // ========= UI State =========
        const el = (id) => document.getElementById(id);

        const weeksScreen = el("weeksScreen");
        const weekScreen = el("weekScreen");
        const weeksGrid = el("weeksGrid");
        const daysRow = el("daysRow");

        const subtitle = el("subtitle");
        const todayPill = el("todayPill");
        const weekCount = el("weekCount");

        const backBtn = el("backBtn");
        const weekTitle = el("weekTitle");
        const weekRange = el("weekRange");

        const overlay = el("overlay");
        const sheet = el("sheet");
        const closeSheet = el("closeSheet");
        const noteInput = el("noteInput");
        const saveNote = el("saveNote");
        const counter = el("counter");
        const sheetTitle = el("sheetTitle");
        const sheetSub = el("sheetSub");
        const notePreview = el("notePreview");

        const now = new Date();
        now.setSeconds(0, 0);

        // Año ISO actual (ojo: 1 enero puede pertenecer al ISO year anterior)
        const isoNow = isoWeekNumber(now);
        const isoYear = isoNow.year;
        const totalWeeks = weeksInISOYear(isoYear);

        subtitle.textContent = `Año ${isoYear} · semanas ISO`;
        todayPill.textContent = `Hoy: ${fmtDateES(now)}`;
        weekCount.textContent = `${totalWeeks} semanas`;

        let selectedWeek = null; // {week, year, start, end}
        let selectedDay = null; // Date

        function showWeeks() {
            weeksScreen.classList.remove("hidden");
            weekScreen.classList.add("hidden");
            selectedWeek = null;
            selectedDay = null;
        }

        function showWeekDetail(weekObj) {
            selectedWeek = weekObj;

            weekTitle.textContent = `Semana ${weekObj.week}`;
            weekRange.textContent = `${fmtDateES(weekObj.start)} → ${fmtDateES(weekObj.end)}`;

            renderDays(weekObj);
            weeksScreen.classList.add("hidden");
            weekScreen.classList.remove("hidden");
        }

        // ========= Render semanas =========
        function renderWeeks() {
            weeksGrid.innerHTML = "";

            // "Hoy" en términos de semana ISO
            const currentISO = isoWeekNumber(now);
            const currentWeek = currentISO.week;
            const currentYear = currentISO.year;

            for (let w = 1; w <= totalWeeks; w++) {
                const start = isoWeekStartFromWeek(isoYear, w);
                const end = addDays(start, 6);

                // Semana "pasada" si ya ha empezado (incluye semana actual)
                // (Si prefieres que la semana actual NO esté rellena hasta terminar, cambia a: end < now)
                const passed = start <= now;

                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "circleBtn" + (passed ? " filled" : "");
                btn.setAttribute("aria-label", `Semana ${w}`);

                const isCurrent = (isoYear === currentYear && w === currentWeek);
                if (isCurrent) btn.className += " currentWeek";

                const c = document.createElement("div");
                c.className = "circle";

                const num = document.createElement("div");
                num.className = "weekNum";
                num.textContent = w;

                btn.appendChild(c);
                btn.appendChild(num);

                btn.addEventListener("click", () => {
                    // micro “snap” satisfactoria
                    btn.animate([{ transform: "scale(1)" }, { transform: "scale(.97)" }, { transform: "scale(1)" }], { duration: 180, easing: "cubic-bezier(.2,.9,.2,1)" });
                    showWeekDetail({ week: w, year: isoYear, start, end });
                });

                weeksGrid.appendChild(btn);
            }
        }

        // ========= Render días =========
        function renderDays(weekObj) {
            daysRow.innerHTML = "";

            const days = [];
            for (let i = 0; i < 7; i++) {
                days.push(addDays(weekObj.start, i));
            }

            // Preview: muestra la primera nota que encuentre (o la del "hoy" si está en esta semana)
            updatePreview(days);

            days.forEach((dateObj, i) => {
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "dayBtn";
                btn.setAttribute("aria-label", `Día ${dayAbbrES(i)} ${fmtDateES(dateObj)}`);

                const has = (getNote(dateObj).trim().length > 0);
                const isToday = isSameDay(dateObj, now);

                const circle = document.createElement("div");
                circle.className = "dayCircle";
                if (has) circle.classList.add("hasNote");
                if (isToday) circle.classList.add("today");

                const label = document.createElement("div");
                label.className = "dayLabel";
                label.textContent = dayAbbrES(i);

                circle.appendChild(label);
                btn.appendChild(circle);

                btn.addEventListener("click", () => openSheetForDay(dateObj, i, weekObj));

                daysRow.appendChild(btn);
            });
        }

        function updatePreview(days) {
            // Prioridad: si "hoy" está en la semana, enseña su nota
            let pick = null;
            for (const d of days) {
                if (isSameDay(d, now)) { pick = d; break; }
            }
            // si no, coge la primera con nota
            if (!pick) {
                for (const d of days) {
                    if (getNote(d).trim().length) { pick = d; break; }
                }
            }

            if (!pick) {
                notePreview.innerHTML = `<span>Toque un día para añadir una nota breve.</span>`;
                return;
            }

            const t = getNote(pick).trim();
            if (!t) {
                notePreview.innerHTML = `<strong>${fmtDateES(pick)}</strong> · <span>sin nota</span>`;
            } else {
                notePreview.innerHTML = `<strong>${fmtDateES(pick)}</strong> · <span>${escapeHtml(t)}</span>`;
            }
        }

        function escapeHtml(str) {
            return str.replace(/[&<>"']/g, (m) => ({
                "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
            }[m]));
        }

        // ========= Sheet (nota) =========
        function openSheetForDay(dateObj, idx, weekObj) {
            selectedDay = dateObj;

            const abbr = dayAbbrES(idx);
            sheetTitle.textContent = `${abbr} · ${fmtDateES(dateObj)}`;
            sheetSub.textContent = `Semana ${weekObj.week} · ${weekObj.year}`;

            const existing = getNote(dateObj);
            noteInput.value = existing;
            counter.textContent = `${noteInput.value.length}/50`;

            overlay.classList.add("show");
            sheet.classList.add("show");

            // focus suave
            setTimeout(() => noteInput.focus({ preventScroll: true }), 80);

            // Swipe-down to close (simple)
            attachSwipeToClose();
        }

        function closeSheetUI() {
            overlay.classList.remove("show");
            sheet.classList.remove("show");
            selectedDay = null;
        }

        function saveCurrent() {
            if (!selectedDay) return;
            setNote(selectedDay, noteInput.value);

            // re-render quick
            if (selectedWeek) renderDays(selectedWeek);
            closeSheetUI();
        }

        noteInput.addEventListener("input", () => {
            // hard cap + counter
            if (noteInput.value.length > 50) noteInput.value = noteInput.value.slice(0, 50);
            counter.textContent = `${noteInput.value.length}/50`;
        });

        saveNote.addEventListener("click", saveCurrent);
        closeSheet.addEventListener("click", closeSheetUI);
        overlay.addEventListener("click", closeSheetUI);

        // Guardar con Enter (sin saltos)
        noteInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                saveCurrent();
            }
            if (e.key === "Escape") {
                e.preventDefault();
                closeSheetUI();
            }
        });

        backBtn.addEventListener("click", showWeeks);

        // ========= Gesture swipe down =========
        let swipeBound = false;
        function attachSwipeToClose() {
            if (swipeBound) return;
            swipeBound = true;

            let startY = 0;
            let currentY = 0;
            let dragging = false;

            const onDown = (e) => {
                if (!sheet.classList.contains("show")) return;
                dragging = true;
                startY = (e.touches ? e.touches[0].clientY : e.clientY);
                currentY = startY;
            };
            const onMove = (e) => {
                if (!dragging) return;
                currentY = (e.touches ? e.touches[0].clientY : e.clientY);
                const dy = Math.max(0, currentY - startY);
                sheet.style.transform = `translateY(${dy}px)`;
                sheet.style.opacity = String(Math.max(0.6, 1 - dy / 260));
                sheet.style.filter = `blur(${Math.min(14, dy / 30)}px)`;
            };
            const onUp = () => {
                if (!dragging) return;
                dragging = false;
                const dy = Math.max(0, currentY - startY);

                sheet.style.transform = "";
                sheet.style.opacity = "";
                sheet.style.filter = "";

                if (dy > 90) closeSheetUI();
            };

            sheet.addEventListener("touchstart", onDown, { passive: true });
            sheet.addEventListener("touchmove", onMove, { passive: true });
            sheet.addEventListener("touchend", onUp, { passive: true });
        }

        // ========= Init =========
        renderWeeks();

        // Mantener “actualizado” el día (por si la pestaña queda abierta)
        setInterval(() => {
            const d = new Date();
            if (!isSameDay(d, now)) {
                location.reload();
            }
        }, 60_000);
    </script>
</body>

</html>